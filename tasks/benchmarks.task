require 'timeout'

desc "Run Celluloid benchmarks"
task :benchmark do
  # Travis has an out-of-date version of rbx that rashes on the benchmarks
  exit 0 if ENV['CI'] and RUBY_ENGINE == 'rbx'

  begin
    Timeout.timeout(120) do
      %w(actor mailbox ring).each do |benchmark|
        load File.expand_path("../../benchmarks/#{benchmark}.rb", __FILE__)
      end
    end
  rescue Exception, Timeout::Error => ex
    puts "ERROR: Couldn't complete benchmark: #{ex.class}: #{ex}"
    puts "  #{ex.backtrace.join("\n  ")}"

    exit 1 unless ENV['CI'] # Hax for running benchmarks on Travis
  end
end
